name: Distribute app

on:
  workflow_dispatch:
  create:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'

jobs:
  build_android:
    name: Build and release Android app
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: "16.x"
      - uses: actions/setup-ruby@v1
        with:
          ruby-version: "3.x"
      - name: Decode Keystore
        uses: timheuer/base64-to-file@v1
        with:
          fileName: 'android/app/haqq-upload-key.keystore'
          encodedString: ${{ secrets.HAQQ_KEYSTORE }}
      - name: Install Fastlane
        run: |
          bundle install
          bundle exec fastlane add_plugin firebase_app_distribution
      - name: Install packages
        run: yarn install
      - name: Execute Fastlane command
        run: bundle exec fastlane android distribute
        env:
          HAQQ_UPLOAD_STORE_FILE: ${{ secrets.HAQQ_UPLOAD_STORE_FILE }}
          HAQQ_UPLOAD_STORE_PASSWORD: ${{ secrets.HAQQ_UPLOAD_STORE_PASSWORD }}
          HAQQ_UPLOAD_KEY_ALIAS: ${{ secrets.HAQQ_UPLOAD_KEY_ALIAS }}
          HAQQ_UPLOAD_KEY_PASSWORD: ${{ secrets.HAQQ_UPLOAD_KEY_PASSWORD }}
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          FIREBASE_TESTERS: ${{ secrets.FIREBASE_TESTERS }}
